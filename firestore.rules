/**
 * Core Philosophy: This ruleset is configured for an open testing environment.
 * Any signed-in user can read all data and write their own data. This is NOT
 * suitable for production but is ideal for development and testing, as it

 * allows easy data inspection and manipulation.
 *
 * Data Structure: The data is organized hierarchically. A top-level 'distributors'
 * collection holds individual distributor profiles. All related data, such as
 * 'performanceMetrics', is stored in subcollections under the corresponding
 * distributor's document.
 *
 * Key Security Decisions for Testing:
 * - Open Read Access: All authenticated users can read all documents in the
 *   'distributors' collection and their subcollections.
 * - User-Owned Writes: A user can only create, update, or delete data that
 *   corresponds to their own authentication UID. This prevents users from
 *   modifying each other's data while still allowing broad read access.
 * - Admin Override: A designated admin user has full write access to all distributor data.
 * - Default Deny: Any path not explicitly defined in these rules is inaccessible.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable, reusable logic

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the designated admin.
     * The admin UID is hardcoded here for simplicity in a development environment.
     */
    function isAdmin() {
      // UID of the admin user.
      return request.auth.uid == '3HnlVIX0LXdkIynM14QVKn4YP0b2';
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the core of the ownership model for write operations.
     * @param userId The user ID to check against the request's auth UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to the distributors collection.
     * @path /distributors
     * @allow Any authenticated user can create a new distributor document.
     */
    match /distributors/{distributorId} {
      // Allow any signed-in user to create new distributors.
      // The application logic assigns the parent, so this is safe.
      allow create: if isSignedIn();

      /**
       * @description Controls access to individual distributor profiles.
       * @path /distributors/{distributorId}
       * @allow Any authenticated user can read any distributor profile.
       * @allow A user can only update/delete their own profile, unless they are an admin.
       */
      // Allow any signed-in user to read for testing purposes.
      allow read: if isSignedIn();
      
      // Allow update/delete only if the user is the owner or an admin.
      allow update, delete: if isOwner(distributorId) || isAdmin();

      /**
       * @description Controls access to a distributor's performance metrics. Open read for testing.
       * @path /distributors/{distributorId}/performanceMetrics/{metricId}
       * @allow Any authenticated user can read any performance metric.
       * @allow A user can only write to their own metrics, unless they are an admin.
       */
      match /performanceMetrics/{metricId} {
        // Allow any signed-in user to read for testing purposes.
        allow read: if isSignedIn();
        // The owner OR an admin can write to the subcollections.
        allow write: if isOwner(distributorId) || isAdmin();
      }
    }
  }
}
