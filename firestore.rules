/**
 * Core Philosophy: This ruleset is configured for an open testing environment.
 * Any signed-in user can read all data and write their own data. This is NOT
 * suitable for production but is ideal for development and testing, as it
 * allows easy data inspection and manipulation.
 *
 * Data Structure: The data is organized hierarchically. A top-level 'distributors'
 * collection holds individual distributor profiles. All related data, such as
 * 'performanceMetrics', is stored in subcollections under the corresponding
 * distributor's document.
 *
 * Key Security Decisions:
 * - Admin Override: A designated admin user has full read and write access to all distributor data.
 * - Open Read Access: All authenticated users can read all documents in the
 *   'distributors' collection and their subcollections.
 * - User-Owned Writes: A user can only create, update, or delete data that
 *   corresponds to their own authentication UID, with some exceptions for rank advancement.
 * - Funded Status: A distributor must be 'funded' to be a parent, ensuring that only
 *   qualified members contribute to upline advancement.
 * - Default Deny: Any path not explicitly defined in these rules is inaccessible.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable, reusable logic
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the designated admin.
     */
    function isAdmin() {
      return request.auth.uid == 'eFcPNPK048PlHyNqV7cAz57ukvB2';
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the core of the ownership model for write operations.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to the distributors collection.
     */
    match /distributors/{distributorId} {
      /**
       * Allow any signed-in user to create their own distributor document.
       * The `parentId` must be a valid, funded distributor if provided.
       */
      allow create: if isSignedIn() &&
                       isOwner(distributorId) &&
                       (request.resource.data.parentId == null || 
                        get(/databases/$(database)/documents/distributors/$(request.resource.data.parentId)).data.status == 'funded');

      /**
       * Allow read access to all authenticated users.
       */
      allow read: if isSignedIn();
      
      /**
       * Allow updates if user is the owner or an admin.
       * If changing the parent, the new parent must be funded.
       */
      allow update: if (isAdmin() || isOwner(distributorId)) &&
                      (request.resource.data.parentId == resource.data.parentId ||
                       get(/databases/$(database)/documents/distributors/$(request.resource.data.parentId)).data.status == 'funded');

      /**
       * Allow delete if user is the owner or an admin.
       */
      allow delete: if isAdmin() || isOwner(distributorId);


      /**
       * @description Controls access to a distributor's performance metrics.
       */
      match /performanceMetrics/{metricId} {
        allow read: if isSignedIn();
        allow write: if isAdmin() || isOwner(distributorId);
      }
    }
  }
}
